<!-- Critical CSS to prevent flash when sliding in -->
<script>
  if (sessionStorage.getItem('chatShouldSlideIn') === 'true') {
    document.write('<style id="chat-slide-preload">#chat-page-container { transform: translateX(100%); visibility: hidden; }</style>');
  }
</script>

<div class="chat-page" data-controller="slide-transition chat-scroll" id="chat-page-container">

  <!-- Chat Header (Fixed) -->
  <div class="page-header">
    <div class="chat-branding">
      <div class="avatar-square">
        <%= link_to root_path do %>
        <%= image_tag 'fox-avatar-min.png', alt: 'resQ AI', class: 'avatar-img' %>
        <% end %>
      </div>
      <span class="chat-brand-text">AI Assistant</span>
    </div>
    <%= link_to vets_path(intake_id: @intake&.id),
      class: vet_button_classes(@result),
      data: {action: "click->slide-transition#slideToVets"}  do %>
      <div class="medical-icon">
        <%= content_tag :i, "", class: "fa-solid fa-briefcase-medical" %>
      </div> Find Vets Nearby
    <% end %>
  </div>

  <!-- Error alert if AI failed -->
  <% if @status == "error" %>
    <div class="alert alert-danger mx-3 mt-3 text-center">
      ⚠️ AI error: <%= @error_message.presence || "An unexpected problem occurred. Please try again later." %>
    </div>
  <% end %>

  <!-- Scrollable Messages Area -->
  <div class="chat-messages-container" data-chat-scroll-target="container">

    <% if @intake.present? && !@mock%>
      <!-- Real AI mode: every chat bubble comes from the database so the poll controller can refresh them -->
      <div id="chat_messages">
        <% (@chat_messages || []).each do |message| %>
          <%= render partial: "intakes/message", locals: { message: message } %>
        <% end %>
      </div>

    <% elsif @mock %>
      <!-- --- MOCK MODE (Frontend only, no database) ---
           When mock mode is active, there is no Intake record in the database.
           Instead, fake data is generated in the controller and rendered directly here.
           This is purely for demo/testing purposes, so refreshing the page will lose the data.
           -->
      <%= render partial: "intakes/mock_message" %>

    <% else %>
      <!-- Fallback if no AI response -->
      <div class="alert alert-warning text-center fw-bold">
        ⚠️ No AI response available.
      </div>
    <% end %>
  </div>

  <!-- Fixed Input Area at Bottom -->
    <% if @intake.present? && @intake.persisted? && !@mock %>
      <div class="chat-input-fixed">
        <%= form_with url: message_intake_path(@intake), method: :post, local: true, data: { controller: "chat-form", action: "submit->chat-form#submitMessage" }, class: "chat-input-form" do |f| %>
          <div class="input-wrapper">
            <%= f.text_field :content, name: "message[content]", placeholder: "Type your message...", class: "chat-input", autocomplete: "off", data: { chat_form_target: "input" } %>
            <%= f.submit "Send", class: "chat-send-btn", data: { chat_form_target: "submit" } %>
          </div>
        <% end %>
      </div>
    <% end %>

</div>
