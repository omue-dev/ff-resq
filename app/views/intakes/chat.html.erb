<% should_slide = session.delete(:slide_transition) || false %>
<div class="chat-container mt-5" data-controller="slide-transition" data-slide-transition-slide-in-value="<%= should_slide %>" style="<%= 'transform: translateX(100%);' if should_slide %>">
  <h1 class="text-center mb-4">resQ AI Chat</h1>

  <!-- --- Error alert if AI failed --- -->
  <% if @status == "error" %>
    <div class="alert alert-danger text-center fw-bold">
      ‚ö†Ô∏è AI error:
      <%= @error_message.presence || "An unexpected problem occurred. Please try again later." %>
    </div>
  <% end %>

  <!-- --- Chat window area --- -->
  <div class="chat-window shadow-sm bg-secondary p-4 border border-4 border-dark">

    <% if @intake.present? && !@mock%>
      <!-- Real AI mode: every chat bubble comes from the database so the poll controller can refresh them -->
      <div id="chat_messages">
        <% (@chat_messages || []).each do |message| %>
          <%= render partial: "intakes/message", locals: { message: message } %>
        <% end %>
      </div>

    <% elsif @mock %>
      <!-- --- MOCK MODE (Frontend only, no database) ---
           When mock mode is active, there is no Intake record in the database.
           Instead, fake data is generated in the controller and rendered directly here.
           This is purely for demo/testing purposes, so refreshing the page will lose the data.
           -->
      <div id="chat_messages">

        <!-- --- Mock user message bubble ---
            This represents what a user would type into the chat.
            -->
        <div class="chat-bubble user-message mb-3">
          I found an injured pigeon near the park. It can't fly and looks weak. What should I do?
        </div>

        <!-- --- Mock assistant (AI) reply bubble with animation testing ---
            This simulates the AI's response with proper structure for testing GSAP animations.
            -->
        <div id="mock_message_wrapper" data-controller="animation-test">
          <div class="chat-bubble ai-message bg-dark text-white animated-bubble position-relative mb-3"
               data-message="Thank you for helping this bird! Let's get it safely contained and then find it expert care.<div class='mt-3'><h5>Approach</h5><p>Approach slowly and quietly. Avoid sudden movements to reduce stress on the bird.</p><h5>Containment</h5><p>Gently place a lightweight towel over the bird. Carefully pick it up, supporting its body and wings.</p></div>"
               data-animation-test-target="bubble">

            <!-- Empty span that will be filled with content via animation -->
            <span class="ai-text"></span>

            <!-- Thinking indicator (will be removed after animation) -->
            <div class="thinking-loader" data-thinking>
              <span class="thinking-text">Thinking</span>
              <svg class="typing-dots" width="24" height="16" viewBox="0 -6 24 16">
                <circle cx="4"  cy="4" r="3"></circle>
                <circle cx="12" cy="4" r="3"></circle>
                <circle cx="20" cy="4" r="3"></circle>
              </svg>
            </div>
          </div>

          <!-- Animation testing controls -->
          <div class="text-center mt-3 mb-3">
            <button class="btn btn-primary" data-action="click->animation-test#replay">
              üîÑ Replay Animation
            </button>
          </div>
        </div>
      </div>

    <% else %>
      <!-- Fallback if no AI response -->
      <div class="alert alert-warning text-center fw-bold">
        ‚ö†Ô∏è No AI response available.
      </div>
    <% end %>
  </div>

  <!-- --- Chat input area ---
       The user can submit a new message here.
       When mock mode is enabled, the request will generate fake data in the controller
       and render this same view without any database interaction.
       -->
  <% if @intake.present? && @intake.persisted? && !@mock %>
    <div class="chat-input-area mt-3">
      <%= form_with url: message_intake_path(@intake), method: :post, local: true, data: { turbo: false }, class: "d-flex" do |f| %>
        <%= f.text_field :content, name: "message[content]", placeholder: "Type your message...", class: "form-control me-2 chat-input" %>
        <%= f.submit "Send", class: "btn btn-dark" %>
      <% end %>
    </div>
  <% elsif @mock %>
    <div class="chat-input-area mt-3">
      <div class="alert alert-info text-center">
        üìù Mock mode - Input disabled. Refresh to start a real conversation.
      </div>
    </div>
  <% end %>

  <!-- --- Navigation area --- -->
  <div class="text-center mt-4">
    <%= link_to "Show vets nearby", vets_path, class: "btn btn-outline-dark btn-lg" %>
  </div>
</div>
