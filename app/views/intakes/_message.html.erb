<% animate = local_assigns.fetch(:animate, false) %>
<% message_dom_id = message.respond_to?(:to_key) ? dom_id(message) : "message_#{message.id}" %>

<% if message.role == "assistant" %>
  <!-- WRAPPER -->
  <div id="<%= message_dom_id %>_wrapper">
    <div class="chat-bubble ai-message bg-dark text-white animated-bubble position-relative mb-3"
     data-message="<%= message.content %>">

      <% if animate %>
        <!-- Placeholder for typing -->
        <span class="ai-text"></span>
      <% else %>
        <%= raw(message.content) %>
      <% end %>

      <% if message.respond_to?(:pending?) && message.pending? %>
        <!-- thinking loader shown while pending -->
        <div class="thinking-note"></div>
        <div class="thinking-loader" data-thinking>
          <svg class="typing-dots" width="24" height="8" viewBox="0 0 24 8">
            <circle cx="4"  cy="4" r="3"></circle>
            <circle cx="12" cy="4" r="3"></circle>
            <circle cx="20" cy="4" r="3"></circle>
          </svg>
        </div>
      <% end %>
    </div>

    <% if message.is_a?(ChatMessage) && message.persisted? && message.pending? %>
      <!-- Stimulus poll controller keeps replacing this bubble until pending? turns false -->
      <div data-controller="poll"
           data-poll-url-value="<%= chat_message_path(message) %>"
           data-poll-target-value="<%= message_dom_id %>_wrapper">
      </div>
    <% end %>
  </div>
<% else %>
  <div class="chat-bubble user-message animated-bubble mb-3" id="<%= message_dom_id %>">
    <% if message.photo_url.present? %>
      <div class="mb-2">
        <%= image_tag message.photo_url, class: "img-thumbnail", style: "max-width: 200px; max-height: 200px; object-fit: cover;" %>
      </div>
    <% end %>
    <%= simple_format(message.content) %>
  </div>
<% end %>
