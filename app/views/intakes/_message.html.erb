<% animate = local_assigns.fetch(:animate, false) %>
<% message_dom_id = message.respond_to?(:to_key) ? dom_id(message) : "message_#{message.id}" %>

<% if message.role == "assistant" %>
  <!-- WRAPPER -->
  <div id="<%= message_dom_id %>_wrapper" class="message-row ai-row">
    <div class="message-avatar ai-avatar">
      <%= image_tag 'fox-avatar-min.png', alt: 'resQ AI', class: 'avatar-img' %>
    </div>
    <div class="chat-bubble ai-message text-white animated-bubble position-relative"
     data-message="<%= message.content %>">

      <% if animate %>
        <!-- Placeholder for typing -->
        <span class="ai-text"></span>
      <% else %>
        <%= raw(message.content) %>
      <% end %>

      <% if message.respond_to?(:pending?) && message.pending? %>
        <!-- thinking loader shown while pending -->
        <div class="thinking-loader" data-thinking>
          <span class="thinking-text">Thinking</span>
          <svg class="typing-dots" width="24" height="16" viewBox="0 -6 24 16">
            <circle cx="4"  cy="4" r="3"></circle>
            <circle cx="12" cy="4" r="3"></circle>
            <circle cx="20" cy="4" r="3"></circle>
          </svg>
        </div>
      <% end %>
    </div>

    <% if message.is_a?(ChatMessage) && message.persisted? && message.pending? %>
      <!-- Stimulus poll controller keeps replacing this bubble until pending? turns false -->
      <div data-controller="poll"
           data-poll-url-value="<%= chat_message_path(message) %>"
           data-poll-target-value="<%= message_dom_id %>_wrapper">
      </div>
    <% end %>
  </div>
<% else %>
  <div class="message-row user-row" id="<%= message_dom_id %>_wrapper">
    <div id="<%= message_dom_id %>" class="chat-bubble user-message animated-bubble">
      <% if message.photo_url.present? %>
        <div class="mb-2">
          <%= image_tag message.photo_url, class: "img-thumbnail chat-message-photo" %>
        </div>
      <% end %>
      <%= simple_format(message.content) %>
    </div>
    <div class="message-avatar user-avatar">
      <%= content_tag :i, "", class: "fa-solid fa-user" %>
    </div>

    <% if message.is_a?(ChatMessage) && message.persisted? && message.pending? %>
      <!-- Poll for photo upload completion -->
      <div data-controller="poll"
           data-poll-url-value="<%= chat_message_path(message) %>"
           data-poll-target-value="<%= message_dom_id %>_wrapper">
      </div>
    <% end %>
  </div>
<% end %>
