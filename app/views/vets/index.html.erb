<h1>Nearby Vets</h1>

<!-- The div where the map will appear -->
<div id="map" style="height: 500px; width: 100%; border-radius: 10px;"></div>

<!-- Load the Google Maps JavaScript SDK with the Places library -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&libraries=places">
</script>

<script>
  // ðŸ”¹ When the page finishes loading, run the initMap function
  window.addEventListener("load", initMap);

  // ðŸ”¹ Main function that sets up the map
  function initMap() {
    // Check if the browser supports geolocation
    if (navigator.geolocation) {
      // If yes, ask for the user's location
      navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
    } else {
      // If not, show an alert
      alert("Geolocation is not supported by your browser!");
    }
  }

  // ðŸ”¹ Runs if the user's location is successfully found
  function successCallback(position) {
    // Store the user's latitude and longitude
    const userLocation = {
      lat: position.coords.latitude,
      lng: position.coords.longitude
    };

    // Create the map centered on the user's location
    const map = new google.maps.Map(document.getElementById("map"), {
      center: userLocation,
      zoom: 14
    });

    // Add a marker to show where the user is
    new google.maps.Marker({
      position: userLocation,
      map: map,
      title: "You are here",
      icon: {
        url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" // blue marker icon
      }
    });

    // Create a PlacesService instance linked to the map
    const service = new google.maps.places.PlacesService(map);

    // ðŸ”¹ Search for nearby vets
    service.nearbySearch(
      {
        // Where to search
        location: userLocation,
        // Distance in meters (3000 = 3 km)
        radius: 10000,
        // What type of places to search for
        type: ["veterinary_care"]
      },
      // ðŸ”¹ Callback function that runs when Google sends back results
      function(results, status) {
        // If the request was successful
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          // Loop through each place found
          results.forEach(place => {
            // Create a marker for each vet clinic
            createMarker(place, map);
          });
        } else {
          // Log an error if something went wrong
          console.error("Places API request failed:", status);
        }
      }
    );
  }

  // ðŸ”¹ Runs if location access fails (user blocks it or error occurs)
  function errorCallback() {
    alert("We couldn't get your location. Please enable location access and reload the page.");
  }

  // ðŸ”¹ Helper function to create markers for each vet found
  function createMarker(place, map) {
    // Create the marker on the map at the vet's coordinates
    const marker = new google.maps.Marker({
      map: map,
      position: place.geometry.location,
      title: place.name
    });

    // Create an info window that pops up when you click a marker
    const infoWindow = new google.maps.InfoWindow({
      content: `
        <strong>${place.name}</strong><br>
        ${place.vicinity || "Address not available"}<br>
        ${place.rating ? "â­ " + place.rating + "/5" : ""}
      `
    });

    // Add a click listener to open the info window
    marker.addListener("click", () => {
      infoWindow.open(map, marker);
    });
  }
</script>
