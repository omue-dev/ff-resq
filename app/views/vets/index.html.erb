<h1>Nearby Vets</h1>

<!-- Map container -->
<div id="map" style="height: 500px; width: 100%; border-radius: 10px;"></div>

<!-- Load the new Google Maps JavaScript SDK with the Places library -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&libraries=places">
</script>

<script>
  // ‚úÖ Wait until the page finishes loading before starting
  window.addEventListener("load", initMap);

  // ------------------------------------------------------------
  // STEP 1: Initialize the map and ask for the user's location
  // ------------------------------------------------------------
  async function initMap() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
    } else {
      alert("Geolocation is not supported by your browser!");
    }
  }

  // ------------------------------------------------------------
  // STEP 2: If location is found, show the map and find nearby vets
  // ------------------------------------------------------------
  async function successCallback(position) {
    // Store the user's latitude and longitude
    const userLocation = {
      lat: position.coords.latitude,
      lng: position.coords.longitude
    };

    // Create the map centered on the user's location
    const map = new google.maps.Map(document.getElementById("map"), {
      center: userLocation,
      zoom: 14
    });

    // Add a blue marker showing where the user is
    new google.maps.marker.AdvancedMarkerElement({
      map,
      position: userLocation,
      title: "You are here",
      content: createCustomMarker("üìç You are here")
    });

    // ------------------------------------------------------------
    // STEP 3: Use the new Places API to search for nearby vets
    // ------------------------------------------------------------
    try {
      // Define your search request
      const request = {
        // What information to return for each place
        fields: ["displayName", "formattedAddress", "location", "rating"],
        // Where to search (a circular area)
        locationBias: {
          circle: {
            center: userLocation,
            radius: 5000 // 5 km search radius
          }
        },
        // Limit to veterinary clinics
        includedTypes: ["veterinary_care"]
      };

      // Make the request using the new async API
      const { places } = await google.maps.places.Place.searchNearby(request);

      // If places were found, create markers for each
      if (places && places.length > 0) {
        places.forEach(place => createVetMarker(place, map));
      } else {
        alert("No nearby vets found within 5 km.");
      }
    } catch (error) {
      console.error("Places API error:", error);
      alert("Something went wrong fetching nearby vets. Check your API key and billing settings.");
    }
  }

  // ------------------------------------------------------------
  // STEP 4: If location access fails
  // ------------------------------------------------------------
  function errorCallback() {
    alert("We couldn't get your location. Please enable location access and reload the page.");
  }

  // ------------------------------------------------------------
  // STEP 5: Helper function to create a vet marker on the map
  // ------------------------------------------------------------
  function createVetMarker(place, map) {
    // Create the marker using the new AdvancedMarkerElement
    const marker = new google.maps.marker.AdvancedMarkerElement({
      map,
      position: place.location,
      title: place.displayName,
      content: createCustomMarker("üêæ")
    });

    // Create an info window for the marker
    const infoWindow = new google.maps.InfoWindow({
      content: `
        <strong>${place.displayName}</strong><br>
        ${place.formattedAddress || "Address not available"}<br>
        ${place.rating ? "‚≠ê " + place.rating + "/5" : ""}
      `
    });

    // Show info window on click
    marker.addListener("click", () => {
      infoWindow.open(map, marker);
    });
  }

  // ------------------------------------------------------------
  // STEP 6: Small helper to make custom markers with emojis or icons
  // ------------------------------------------------------------
  function createCustomMarker(label) {
    const div = document.createElement("div");
    div.style.background = "#fff";
    div.style.border = "2px solid #000";
    div.style.borderRadius = "50%";
    div.style.padding = "6px";
    div.style.fontSize = "16px";
    div.textContent = label;
    return div;
  }
</script>
